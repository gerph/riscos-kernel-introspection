/*******************************************************************
 * File:        osplatformfeatures
 * Purpose:     Implementation of the OS_PlatformFeatures SWI calls
 * Author:      Gerph
 * Date:        21 Dec 2025
 ******************************************************************/

#include <stdlib.h>
#include <stdio.h>
#include <stdint.h>

#include "kernel.h"
#include "swis.h"

#include "riscos/OSPlatformFeatures.h"

#include "modhead.h"


//#define DEBUG


#ifdef DEBUG
#define dprintf if (1) printf
#else
#define dprintf if (0) printf
#endif

#ifndef OS_PlatformFeatures_CPUVectorsLocation
#define OS_PlatformFeatures_CPUVectorsLocation           (0x20)
#define OS_PlatformFeatures_CacheInformation             (0x21)
#define OS_PlatformFeatures_CPUFeatures                  (0x22)
#define OS_PlatformFeatures_ReadClearExclusiveMonitor    (0x23)
#define OS_PlatformFeatures_DescribeCPURegisters         (0x40)
#endif

#ifndef OSPlatformFeaturesCode_CPUHasSeparateCaches
#define OSPlatformFeaturesCode_CPUHasSeparateCaches      (1<<5)
//#define OSPlatformFeaturesCode_OperatingSystemIs32Bit    (1<<6)
//#define OSPlatformFeaturesCode_26BitUnavailable          (1<<7)
#define OSPlatformFeaturesCode_CPUHasMExtensions         (1<<8)
#define OSPlatformFeaturesCode_CPUSupportsThumb          (1<<9)
#define OSPlatformFeaturesCode_CPUHasEExtensions         (1<<10)
#define OSPlatformFeaturesCode_CPUHasNoSWP               (1<<11)
#define OSPlatformFeaturesCode_CPUHasLDRSTREX            (1<<12)
#define OSPlatformFeaturesCode_CPUHasCLREX               (1<<13)
#define OSPlatformFeaturesCode_CannotDisableDCache       (1<<14)
#define OSPlatformFeaturesCode_CPUExtendedSmallPages     (1<<15)
#define OSPlatformFeaturesCode_CPUHasNoDWB               (1<<16)
#define OSPlatformFeaturesCode_CPUHasBrokenAborts        (1<<17)
#define OSPlatformFeaturesCode_CPUIsXScale               (1<<18)
#define OSPlatformFeaturesCode_XScaleJTAG                (1<<19)
#define OSPlatformFeaturesCode_HighVectors               (1<<20)
#define OSPlatformFeaturesCode_LargePhysicalRAM          (1<<21)
#define OSPlatformFeaturesCode_NoPhysicalPages           (1<<22)
#define OSPlatformFeaturesCode_InvalidReasonsAreSafe     (1u<<31)
#endif


_kernel_oserror *platformfeatures_readcodefeatures(_kernel_swi_regs *r)
{
    /*
    OS_PlatformFeatures &00 - Read Code Features

    =>  R0 = 0

    <=  R0 = platform feature flags
        R1 = IRQ trigger function, or 0 if no routine is necessary
    */
    _kernel_oserror *err = NULL;
    uint32_t flags = 0;

#ifdef __riscos64
    /* This is approximately correct for RISC OS 64 - options that are not valid for AArch64 are ignored */
    flags |= OSPlatformFeaturesCode_SynchroniseCodeAreasRequired;
    flags |= OSPlatformFeaturesCode_CannotDisableDCache;
    flags |= OSPlatformFeaturesCode_NoPhysicalPages;
    flags |= OSPlatformFeaturesCode_InvalidReasonsAreSafe;
#else
    /* 32bit RISC OS - we've just set every single flag ! */
    flags |= OSPlatformFeaturesCode_SynchroniseCodeAreasRequired;
    flags |= OSPlatformFeaturesCode_IRQTriggerNecessary;
    flags |= OSPlatformFeaturesCode_HardwareVectorsNeed32bitMode;
    flags |= OSPlatformFeaturesCode_PCStoresPlus8;
    flags |= OSPlatformFeaturesCode_DataAbortsEarly;
    flags |= OSPlatformFeaturesCode_CPUHasSeparateCaches;
    flags |= OSPlatformFeaturesCode_OperatingSystemIs32Bit;
    flags |= OSPlatformFeaturesCode_26BitUnavailable;
    flags |= OSPlatformFeaturesCode_CPUHasMExtensions;
    flags |= OSPlatformFeaturesCode_CPUSupportsThumb;
    flags |= OSPlatformFeaturesCode_CPUHasEExtensions;
    flags |= OSPlatformFeaturesCode_CPUHasNoSWP;
    flags |= OSPlatformFeaturesCode_CPUHasLDRSTREX;
    flags |= OSPlatformFeaturesCode_CPUHasCLREX;
    flags |= OSPlatformFeaturesCode_CannotDisableDCache;
    flags |= OSPlatformFeaturesCode_CPUExtendedSmallPages;
    flags |= OSPlatformFeaturesCode_CPUHasNoDWB;
    flags |= OSPlatformFeaturesCode_CPUHasBrokenAborts;
    flags |= OSPlatformFeaturesCode_CPUIsXScale;
    flags |= OSPlatformFeaturesCode_XScaleJTAG;
    flags |= OSPlatformFeaturesCode_HighVectors;
    flags |= OSPlatformFeaturesCode_LargePhysicalRAM;
    flags |= OSPlatformFeaturesCode_NoPhysicalPages;
    flags |= OSPlatformFeaturesCode_InvalidReasonsAreSafe;
#endif

    r->r[0] = flags;
    r->r[1] = 0; /* We don't have any IRQ trigger function */

    return err;
}

_kernel_oserror *platformfeatures_readmmufeatures(_kernel_swi_regs *r)
{
    _kernel_oserror *err = err_NotImplemented;
    return err;
}

_kernel_oserror *platformfeatures_cpuvectorslocation(_kernel_swi_regs *r)
{
    _kernel_oserror *err = err_NotImplemented;
    return err;
}

_kernel_oserror *platformfeatures_cacheinformation(_kernel_swi_regs *r)
{
    /*
    OS_PlatformFeatures &21 - Read cache information

    =>  R0 = 33
        R1 = cache level

    <=  R0 = Cache support:
                b0-2:   Cache type:
                            0:      None
                            1:      Instruction cache
                            2:      Data cache
                            3:      Split I+D cache
                            4:      Unified cache
                            5-7:    Reserved
                b3-31:  Reserved
        R1 = D cache line length in bytes
        R2 = D cache size in bytes
        R3 = I cache line length in bytes
        R4 = I cache size in bytes
    */
    _kernel_oserror *err = err_NotImplemented;
    int cache_level = r->r[1];
    switch (cache_level)
    {
        case 0:
            r->r[0] = (1<<0);        // We have an I cache
            r->r[1] = 0;             // No D cache
            r->r[2] = 0;             // No D cache
            r->r[3] = 4096;          // I cache line is up to a page long (as basic blocks cannot be larger than that)
            r->r[4] = 0xFFFFFFFF;    // I cache could be as large as our whole memory
            err = NULL;
            break;

        case 1:
            r->r[0] = 0;             // No cache - this is the end of the list.
            r->r[1] = 0;
            r->r[2] = 0;
            r->r[3] = 0;
            r->r[4] = 0;
            err = NULL;
            break;

        default:
            break;
    }

    return err;
}

_kernel_oserror *platformfeatures_cpufeatures(_kernel_swi_regs *r)
{
    _kernel_oserror *err = err_NotImplemented;
    return err;
}

_kernel_oserror *platformfeatures_readclearexclusivemonitor(_kernel_swi_regs *r)
{
    _kernel_oserror *err = err_NotImplemented;
    return err;
}


#if ! defined(__riscos64) && defined(__riscos)
static const uint32_t default_cpu_regs32[] = {
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x00000004, /* .... */
    0x00000044, /* D... */
    0x00000000, /* .... */
    0x00000324, /* $... */
    0x00000000, /* .... */
    0x00000020, /*  ... */
    0x00000001, /* .... */
    0x00000327, /* '... */
    0x00000004, /* .... */
    0x00000020, /*  ... */
    0x00000002, /* .... */
    0x0000032A, /* *... */
    0x00000008, /* .... */
    0x00000020, /*  ... */
    0x00000003, /* .... */
    0x0000032D, /* -... */
    0x0000000C, /* .... */
    0x00000020, /*  ... */
    0x00000004, /* .... */
    0x00000330, /* 0... */
    0x00000010, /* .... */
    0x00000020, /*  ... */
    0x00000005, /* .... */
    0x00000333, /* 3... */
    0x00000014, /* .... */
    0x00000020, /*  ... */
    0x00000006, /* .... */
    0x00000336, /* 6... */
    0x00000018, /* .... */
    0x00000020, /*  ... */
    0x00000007, /* .... */
    0x00000339, /* 9... */
    0x0000001C, /* .... */
    0x00000020, /*  ... */
    0x00000008, /* .... */
    0x0000033C, /* <... */
    0x00000020, /*  ... */
    0x00000020, /*  ... */
    0x00000009, /* .... */
    0x0000033F, /* ?... */
    0x00000024, /* $... */
    0x00000020, /*  ... */
    0x0000000A, /* .... */
    0x00000342, /* B... */
    0x00000028, /* (... */
    0x00000020, /*  ... */
    0x0000000B, /* .... */
    0x00000346, /* F... */
    0x0000002C, /* ,... */
    0x00000020, /*  ... */
    0x0000000C, /* .... */
    0x0000034A, /* J... */
    0x00000030, /* 0... */
    0x00000020, /*  ... */
    0x0000000D, /* .... */
    0x0000034E, /* N... */
    0x00000034, /* 4... */
    0x00001020, /*  ... */
    0x0000000E, /* .... */
    0x00000351, /* Q... */
    0x00000038, /* 8... */
    0x00002020, /*   .. */
    0x0000000F, /* .... */
    0x00000354, /* T... */
    0x0000003C, /* <... */
    0x00023020, /*  0.. */
    0x00000010, /* .... */
    0x00000357, /* W... */
    0x00000040, /* @... */
    0x00004020, /*  @.. */
    0x01400000, /* ..@. */
    0x0000035C, /* \... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00000, /* .... */
    0x00000361, /* a... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00100, /* .... */
    0x00000365, /* e... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00200, /* .... */
    0x00000369, /* i... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00300, /* .... */
    0x0000036D, /* m... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00400, /* .... */
    0x00000371, /* q... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00500, /* .... */
    0x00000376, /* v... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00600, /* .... */
    0x0000037B, /* {... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00700, /* .... */
    0x0000037F, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00800, /* .... */
    0x00000383, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00900, /* .... */
    0x00000388, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00A00, /* .... */
    0x0000038D, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00B00, /* .... */
    0x00000391, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00C00, /* .... */
    0x00000395, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00D00, /* .... */
    0x0000039A, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00E00, /* .... */
    0x0000039F, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01800F00, /* .... */
    0x000003A4, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01400004, /* ..@. */
    0x000003A8, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01C00004, /* .... */
    0x000003B0, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01800104, /* .... */
    0x000003B6, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01400005, /* ..@. */
    0x000003BC, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01C00005, /* .... */
    0x000003C5, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01800105, /* .... */
    0x000003C9, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01000006, /* .... */
    0x000003CD, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01000007, /* .... */
    0x000003CF, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01000008, /* .... */
    0x000003D1, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01000009, /* .... */
    0x000003D3, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x0100001B, /* .... */
    0x000003D5, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x0100001C, /* .... */
    0x000003D7, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x0100001D, /* .... */
    0x000003D9, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x0100001E, /* .... */
    0x000003DB, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x0100001F, /* .... */
    0x000003DD, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0xFFFFFFFF, /* .... */
    0x72003072, /* r0.r */
    0x32720031, /* 1.r2 */
    0x00337200, /* .r3. */
    0x72003472, /* r4.r */
    0x36720035, /* 5.r6 */
    0x00377200, /* .r7. */
    0x72003872, /* r8.r */
    0x31720039, /* 9.r1 */
    0x31720030, /* 0.r1 */
    0x31720031, /* 1.r1 */
    0x70730032, /* 2.sp */
    0x00726C00, /* .lr. */
    0x43006370, /* pc.C */
    0x00525350, /* PSR. */
    0x65646F4D, /* Mode */
    0x52535500, /* .USR */
    0x51494600, /* .FIQ */
    0x51524900, /* .IRQ */
    0x43565300, /* .SVC */
    0x30313000, /* .010 */
    0x31300030, /* 0.01 */
    0x4D003130, /* 01.M */
    0x41004E4F, /* ON.A */
    0x31005442, /* BT.1 */
    0x00303030, /* 000. */
    0x31303031, /* 1001 */
    0x50594800, /* .HYP */
    0x444E5500, /* .UND */
    0x30313100, /* .110 */
    0x31310030, /* 0.11 */
    0x31003130, /* 01.1 */
    0x00303131, /* 110. */
    0x00535953, /* SYS. */
    0x6E746942, /* Bitn */
    0x00737365, /* ess. */
    0x69623632, /* 26bi */
    0x32330074, /* t.32 */
    0x00746962, /* bit. */
    0x6F636E45, /* Enco */
    0x676E6964, /* ding */
    0x4D524100, /* .ARM */
    0x6D685400, /* .Thm */
    0x69006600, /* .f.i */
    0x65006100, /* .a.e */
    0x76007100, /* .q.v */
    0x7A006300, /* .c.z */
    0x00006E00, /* .n.. */
};
#endif

#ifdef __riscos64
static const uint32_t default_cpu_regs64[] = {
    0x00000001, /* .... */
    0x00000004, /* .... */
    0x00000004, /* .... */
    0x00000114, /* .... */
    0x00000000, /* .... */
    0x00000434, /* 4... */
    0x00000000, /* .... */
    0x00000040, /* @... */
    0x00000001, /* .... */
    0x00000437, /* 7... */
    0x00000008, /* .... */
    0x00000040, /* @... */
    0x00000002, /* .... */
    0x0000043A, /* :... */
    0x00000010, /* .... */
    0x00000040, /* @... */
    0x00000003, /* .... */
    0x0000043D, /* =... */
    0x00000018, /* .... */
    0x00000040, /* @... */
    0x00000004, /* .... */
    0x00000440, /* @... */
    0x00000020, /*  ... */
    0x00000040, /* @... */
    0x00000005, /* .... */
    0x00000443, /* C... */
    0x00000028, /* (... */
    0x00000040, /* @... */
    0x00000006, /* .... */
    0x00000446, /* F... */
    0x00000030, /* 0... */
    0x00000040, /* @... */
    0x00000007, /* .... */
    0x00000449, /* I... */
    0x00000038, /* 8... */
    0x00000040, /* @... */
    0x00000008, /* .... */
    0x0000044C, /* L... */
    0x00000040, /* @... */
    0x00000040, /* @... */
    0x00000009, /* .... */
    0x0000044F, /* O... */
    0x00000048, /* H... */
    0x00000040, /* @... */
    0x0000000A, /* .... */
    0x00000452, /* R... */
    0x00000050, /* P... */
    0x00000040, /* @... */
    0x0000000B, /* .... */
    0x00000456, /* V... */
    0x00000058, /* X... */
    0x00000040, /* @... */
    0x0000000C, /* .... */
    0x0000045A, /* Z... */
    0x00000060, /* `... */
    0x00000040, /* @... */
    0x0000000D, /* .... */
    0x0000045E, /* ^... */
    0x00000068, /* h... */
    0x00000040, /* @... */
    0x0000000E, /* .... */
    0x00000462, /* b... */
    0x00000070, /* p... */
    0x00000040, /* @... */
    0x0000000F, /* .... */
    0x00000466, /* f... */
    0x00000078, /* x... */
    0x00000040, /* @... */
    0x00000010, /* .... */
    0x0000046A, /* j... */
    0x00000080, /* .... */
    0x00000040, /* @... */
    0x00000011, /* .... */
    0x0000046E, /* n... */
    0x00000088, /* .... */
    0x00000040, /* @... */
    0x00000012, /* .... */
    0x00000472, /* r... */
    0x00000090, /* .... */
    0x00000040, /* @... */
    0x00000013, /* .... */
    0x00000476, /* v... */
    0x00000098, /* .... */
    0x00000040, /* @... */
    0x00000014, /* .... */
    0x0000047A, /* z... */
    0x000000A0, /* .... */
    0x00000040, /* @... */
    0x00000015, /* .... */
    0x0000047E, /* ~... */
    0x000000A8, /* .... */
    0x00000040, /* @... */
    0x00000016, /* .... */
    0x00000482, /* .... */
    0x000000B0, /* .... */
    0x00000040, /* @... */
    0x00000017, /* .... */
    0x00000486, /* .... */
    0x000000B8, /* .... */
    0x00000040, /* @... */
    0x00000018, /* .... */
    0x0000048A, /* .... */
    0x000000C0, /* .... */
    0x00000040, /* @... */
    0x00000019, /* .... */
    0x0000048E, /* .... */
    0x000000C8, /* .... */
    0x00000040, /* @... */
    0x0000001A, /* .... */
    0x00000492, /* .... */
    0x000000D0, /* .... */
    0x00000040, /* @... */
    0x0000001B, /* .... */
    0x00000496, /* .... */
    0x000000D8, /* .... */
    0x00000040, /* @... */
    0x0000001C, /* .... */
    0x0000049A, /* .... */
    0x000000E0, /* .... */
    0x00000040, /* @... */
    0x0000001D, /* .... */
    0x0000049E, /* .... */
    0x000000E8, /* .... */
    0x00000040, /* @... */
    0x0000001E, /* .... */
    0x000004A2, /* .... */
    0x000000F0, /* .... */
    0x00002040, /* @ .. */
    0x0000001F, /* .... */
    0x000004A5, /* .... */
    0x000000F8, /* .... */
    0x00000040, /* @... */
    0x00000020, /*  ... */
    0x000004A9, /* .... */
    0x00000100, /* .... */
    0x00041040, /* @... */
    0x00000021, /* !... */
    0x000004AC, /* .... */
    0x00000108, /* .... */
    0x00023040, /* @0.. */
    0x00000022, /* "... */
    0x000004AF, /* .... */
    0x00000110, /* .... */
    0x00004020, /*  @.. */
    0x01400000, /* ..@. */
    0x000004B6, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00000, /* .... */
    0x000004BA, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00100, /* .... */
    0x000004BE, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00200, /* .... */
    0x000004C2, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00300, /* .... */
    0x000004C6, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00400, /* .... */
    0x000004CA, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00500, /* .... */
    0x000004CF, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00600, /* .... */
    0x000004D4, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00700, /* .... */
    0x000004D8, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00800, /* .... */
    0x000004DC, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00900, /* .... */
    0x000004E1, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00A00, /* .... */
    0x000004E6, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00B00, /* .... */
    0x000004EA, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00C00, /* .... */
    0x000004EE, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00D00, /* .... */
    0x000004F3, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01C00E00, /* .... */
    0x000004F8, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01800F00, /* .... */
    0x000004FD, /* .... */
    0x00000000, /* .... */
    0x00000004, /* .... */
    0x01400002, /* ..@. */
    0x00000501, /* .... */
    0x00000000, /* .... */
    0x00000002, /* .... */
    0x01400004, /* ..@. */
    0x00000504, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01C00004, /* .... */
    0x0000050C, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01800104, /* .... */
    0x00000512, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01000006, /* .... */
    0x00000518, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01000007, /* .... */
    0x0000051A, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01000008, /* .... */
    0x0000051C, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01000009, /* .... */
    0x0000051E, /* .... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01000014, /* .... */
    0x00000520, /*  ... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x01000015, /* .... */
    0x00000522, /* "... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x0100001C, /* .... */
    0x00000524, /* $... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x0100001D, /* .... */
    0x00000526, /* &... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x0100001E, /* .... */
    0x00000528, /* (... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0x0100001F, /* .... */
    0x0000052A, /* *... */
    0x00000000, /* .... */
    0x00000001, /* .... */
    0xFFFFFFFF, /* .... */
    0x78003078, /* x0.x */
    0x32780031, /* 1.x2 */
    0x00337800, /* .x3. */
    0x78003478, /* x4.x */
    0x36780035, /* 5.x6 */
    0x00377800, /* .x7. */
    0x78003878, /* x8.x */
    0x31780039, /* 9.x1 */
    0x31780030, /* 0.x1 */
    0x31780031, /* 1.x1 */
    0x31780032, /* 2.x1 */
    0x31780033, /* 3.x1 */
    0x31780034, /* 4.x1 */
    0x31780035, /* 5.x1 */
    0x31780036, /* 6.x1 */
    0x31780037, /* 7.x1 */
    0x31780038, /* 8.x1 */
    0x32780039, /* 9.x2 */
    0x32780030, /* 0.x2 */
    0x32780031, /* 1.x2 */
    0x32780032, /* 2.x2 */
    0x32780033, /* 3.x2 */
    0x32780034, /* 4.x2 */
    0x32780035, /* 5.x2 */
    0x32780036, /* 6.x2 */
    0x32780037, /* 7.x2 */
    0x32780038, /* 8.x2 */
    0x726C0039, /* 9.lr */
    0x727A7800, /* .xzr */
    0x00707300, /* .sp. */
    0x50006370, /* pc.P */
    0x54415453, /* STAT */
    0x334D0045, /* E.M3 */
    0x53550032, /* 2.US */
    0x49460052, /* R.FI */
    0x52490051, /* Q.IR */
    0x56530051, /* Q.SV */
    0x31300043, /* C.01 */
    0x30003030, /* 00.0 */
    0x00313031, /* 101. */
    0x004E4F4D, /* MON. */
    0x00544241, /* ABT. */
    0x30303031, /* 1000 */
    0x30303100, /* .100 */
    0x59480031, /* 1.HY */
    0x4E550050, /* P.UN */
    0x31310044, /* D.11 */
    0x31003030, /* 00.1 */
    0x00313031, /* 101. */
    0x30313131, /* 1110 */
    0x53595300, /* .SYS */
    0x004C4500, /* .EL. */
    0x6E746942, /* Bitn */
    0x00737365, /* ess. */
    0x69623436, /* 64bi */
    0x32330074, /* t.32 */
    0x00746962, /* bit. */
    0x00690066, /* f.i. */
    0x00640073, /* s.d. */
    0x0074006C, /* l.t. */
    0x00630076, /* v.c. */
    0x006E007A, /* z.n. */
};
#endif

_kernel_oserror *platformfeatures_describecpuregisters(_kernel_swi_regs *r)
{
    /*
    OS_PlatformFeatures &40 - Describe CPU architecture and registers

    =>  R0 = 64

    <=  R0 = pointer to CPU architecture and registers block:
                +0  Architecture identifier:
                        0   ARM 32 bit (A32)
                        1   ARM 64 bit (A64)
                        2   x86 64 bit (x86-64)
                +4  Minimum instruction length in bytes
                +8  Maximum instruction length in bytes
                +12 Total length of the register dump block
                +16... register definitions:
                        +0  -1 if end of list,
                            definition type in bit 24-30, definition specific data in bits 0-23. types:
                                0:  register definition, specific data is:
                                    logical register number (maps to ARM 32 registers)
                                1:  flag definition for prior register
                                        b0-7:   base bit number (values 0-255)
                                        b8-21:  value described (if bit 23 set)
                                        b22-23: 0 => this is the flag name (or name of the region if multiple bits)
                                                1 => this is the flag name and values follow
                                                2 => this is a flag value, and no values follow
                                                3 => this is a flag value, and more values follow
                        +4  offset from base of architecture register block to descriptive name
                        +8  offset of value in the register dump block, or -1 if not present in dump block
                        +12 register flags:
                                b0-11:  Register/Flag: size in bits
                                b12-15: Register: register type:
                                            0: general purpose register
                                            1: stack pointer
                                            2: link register
                                            3: program counter
                                            4: state flags
                                            5-15: reserved
                                b16-23: bit alignment (eg
                                                       0 for byte alignment,
                                                       2 for 4 byte (word) alignment,
                                                       4 for 16 byte alignment)
                                b24-31: reserved
    */
    _kernel_oserror *err = NULL;
#ifdef __riscos64
    r->r[0] = (uint32_t)default_cpu_regs64;
#else
    r->r[0] = (uint32_t)default_cpu_regs32;
#endif
    return err;
}



/***************************************************************************
 * Description:  SWI handler routine. All SWIs for this module will be
 *               passed to these routines.
 * Parameters:   number = SWI number within SWI chunk (i.e. 0 to 63)
 *               r      = pointer to register block on entry
 *               pw     = private word for module
 * On exit:      Return NULL if SWI handled successfully, setting return
 *               register values (r0-r9) in r.
 *               Return error_BAD_SWI for out of range SWIs.
 *               Return an error block for a custom error.
 **************************************************************************/
/* Functions called to handle particular SWI calls */
_kernel_oserror *SWI_PlatformFeatures(int number, _kernel_swi_regs *r, void *pw)
{
    _kernel_oserror *err = err_NotImplemented;
    int reason = r->r[0];

    dprintf("OS_PlatformFeatures #%i\n", reason);

    switch (reason)
    {
        case OS_PlatformFeatures_ReadCodeFeatures:
            err = platformfeatures_readcodefeatures(r);
            break;

        case OS_PlatformFeatures_ReadMMUFeatures:
            err = platformfeatures_readmmufeatures(r);
            break;

        case OS_PlatformFeatures_CPUVectorsLocation:
            err = platformfeatures_cpuvectorslocation(r);
            break;

        case OS_PlatformFeatures_CacheInformation:
            err = platformfeatures_cacheinformation(r);
            break;

        case OS_PlatformFeatures_CPUFeatures:
            err = platformfeatures_cpufeatures(r);
            break;

        case OS_PlatformFeatures_ReadClearExclusiveMonitor:
            err = platformfeatures_readclearexclusivemonitor(r);
            break;

        case OS_PlatformFeatures_DescribeCPURegisters:
            err = platformfeatures_describecpuregisters(r);
            break;

        default:
        /* FIXME: Should be Bad PlatformFeatures */
            err = err_NotImplemented;
            break;
    }
    return err;
}
